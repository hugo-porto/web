{{ define "main" }}
<style>
  /* Hide scrollbar but keep functionality */
  html {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
  }
  
  html::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }
  
  .project-section {
    /* Height based on number of images - each image gets viewport height */
    padding: 4rem 0;
    position: relative;
  }
  
  .project-sticky-container {
    position: sticky;
    top: 100px;
    height: calc(100vh - 200px);
    display: flex;
    gap: 3rem;
    padding: 2rem;
    transition: all 0.3s ease-out;
  }
  
  .project-content {
    flex: 1;
    max-width: 50%;
    overflow-y: auto;
    padding-right: 2rem;
  }
  
  .project-images {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    perspective: 1000px;
  }
  
  .image-stack {
    position: relative;
    width: 100%;
    height: 80%;
  }
  
  .carousel-image {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 600px;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }
  
  /* Scroll indicator */
  .scroll-indicator {
    position: fixed;
    right: 2rem;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    z-index: 50;
  }
  
  .scroll-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(107, 114, 128, 0.3);
    transition: all 0.3s;
    cursor: pointer;
  }
  
  .scroll-dot.active {
    background: rgba(107, 114, 128, 1);
    transform: scale(1.3);
  }
  
  /* Image counter */
  .image-counter {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    z-index: 10;
  }
  
  @media (max-width: 768px) {
    .project-sticky-container {
      flex-direction: column;
    }
    .project-content {
      max-width: 100%;
    }
  }
</style>

<div class="container mx-auto px-4 py-16 max-w-7xl">
  <div class="text-center mb-20">
    <h1 class="text-6xl md:text-7xl font-bold text-gray-800 mb-6 font-poppins">{{ .Title }}</h1>
    <p class="text-2xl text-gray-600">{{ .Description }}</p>
  </div>

  {{ range $index, $page := .Pages }}
    {{ if not $page.IsHome }}
    {{ $numImages := len $page.Params.images }}
    {{ $sectionHeight := mul $numImages 100 }}
    <section class="project-section" data-project-section data-project-index="{{ $index }}" 
             style="min-height: {{ $sectionHeight }}vh;" 
             data-num-images="{{ $numImages }}">
      <div class="project-sticky-container">
        <!-- Left: Content -->
        <div class="project-content">
          <h2 class="text-4xl md:text-5xl font-semibold text-gray-800 mb-4 font-poppins">{{ $page.Title }}</h2>
          
          {{ if $page.Params.description }}
          <p class="text-xl text-gray-600 mb-6 italic">{{ $page.Params.description }}</p>
          {{ end }}

          {{ if $page.Params.tags }}
          <div class="flex flex-wrap gap-2 mb-8">
            {{ range $page.Params.tags }}
            <span class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-medium">{{ . }}</span>
            {{ end }}
          </div>
          {{ end }}

          <div class="prose prose-lg max-w-none text-gray-700 mb-8">
            {{ $page.Content }}
          </div>

          {{ if $page.Params.github }}
          <div class="mt-8">
            <a href="{{ $page.Params.github }}" target="_blank" rel="noopener noreferrer" 
               class="inline-flex items-center px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition text-lg">
              <i class='bx bxl-github text-2xl mr-2'></i>
              View on GitHub
            </a>
          </div>
          {{ end }}
        </div>

        <!-- Right: Image Carousel -->
        <div class="project-images">
          <div class="image-stack" data-image-carousel>
            {{ if $page.Params.images }}
              {{ range $imgIndex, $imgName := $page.Params.images }}
                {{ $imgResource := $page.Resources.GetMatch $imgName }}
                {{ if $imgResource }}
                  <img src="{{ $imgResource.RelPermalink }}" alt="{{ $page.Title }} visualization {{ add $imgIndex 1 }}" 
                       class="carousel-image" 
                       data-image-index="{{ $imgIndex }}"
                       data-total-images="{{ len $page.Params.images }}" />
                {{ end }}
              {{ end }}
              <div class="image-counter">
                <span class="current-image">1</span> / <span class="total-images">{{ len $page.Params.images }}</span>
              </div>
            {{ end }}
          </div>
        </div>
      </div>
    </section>
    {{ end }}
  {{ end }}
</div>

<!-- Scroll Navigation Dots -->
<div class="scroll-indicator" id="scroll-indicator"></div>

<script>
  const projectSections = document.querySelectorAll('[data-project-section]');
  const indicator = document.getElementById('scroll-indicator');
  
  // Create navigation dots
  projectSections.forEach((section, index) => {
    const dot = document.createElement('div');
    dot.className = 'scroll-dot';
    dot.addEventListener('click', () => {
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    indicator.appendChild(dot);
  });
  
  function updateProjectAnimations() {
    const windowHeight = window.innerHeight;
    const dots = document.querySelectorAll('.scroll-dot');
    
    projectSections.forEach((section, sectionIndex) => {
      const rect = section.getBoundingClientRect();
      const sectionTop = rect.top;
      const sectionBottom = rect.bottom;
      const sectionHeight = rect.height;
      const numImages = parseInt(section.dataset.numImages) || 1;
      
      // Check if section is in view
      const isInView = sectionTop < windowHeight && sectionBottom > 0;
      
      // Update active dot - section is active when its center is near viewport center
      const sectionCenter = sectionTop + sectionHeight / 2;
      const viewportCenter = windowHeight / 2;
      const distanceFromCenter = Math.abs(sectionCenter - viewportCenter);
      
      if (distanceFromCenter < sectionHeight / 2) {
        dots.forEach(d => d.classList.remove('active'));
        dots[sectionIndex].classList.add('active');
      }
      
      if (isInView) {
        // Calculate scroll progress through the section (0 = just entered, 1 = about to exit)
        // This gives more precise control over image transitions
        let scrollProgress = 0;
        if (sectionTop > 0) {
          // Section is below viewport top
          scrollProgress = 0;
        } else if (sectionBottom < windowHeight) {
          // Section is above viewport bottom
          scrollProgress = 1;
        } else {
          // Section is in viewport
          scrollProgress = Math.abs(sectionTop) / (sectionHeight - windowHeight);
        }
        scrollProgress = Math.max(0, Math.min(1, scrollProgress));
        
        // Get images in this project
        const carousel = section.querySelector('[data-image-carousel]');
        if (carousel) {
          const images = carousel.querySelectorAll('.carousel-image');
          const counter = carousel.querySelector('.current-image');
          const totalImages = images.length;
          
          if (totalImages > 0) {
            // Determine which image should be active - divide scroll progress by number of images
            // Add a small buffer so each image gets equal time
            const rawIndex = scrollProgress * totalImages;
            const activeIndex = Math.min(Math.floor(rawIndex), totalImages - 1);
            
            // Update counter
            if (counter) {
              counter.textContent = activeIndex + 1;
            }
            
            // Update each image with smoother transitions
            images.forEach((img, imgIndex) => {
              const distanceFromActive = Math.abs(imgIndex - activeIndex);
              
              if (imgIndex === activeIndex) {
                // Active image: full opacity, in front, centered
                img.style.opacity = '1';
                img.style.transform = 'translate(-50%, -50%) scale(1) translateZ(0px)';
                img.style.zIndex = '10';
              } else if (imgIndex < activeIndex) {
                // Images before: stack to the left/back
                const offset = (distanceFromActive * 20);
                img.style.opacity = '0.3';
                img.style.transform = `translate(calc(-50% - ${offset}px), -50%) scale(${0.9 - distanceFromActive * 0.05}) translateZ(-${distanceFromActive * 100}px) rotateY(10deg)`;
                img.style.zIndex = String(10 - distanceFromActive);
              } else {
                // Images after: stack to the right/back
                const offset = (distanceFromActive * 20);
                img.style.opacity = '0.3';
                img.style.transform = `translate(calc(-50% + ${offset}px), -50%) scale(${0.9 - distanceFromActive * 0.05}) translateZ(-${distanceFromActive * 100}px) rotateY(-10deg)`;
                img.style.zIndex = String(10 - distanceFromActive);
              }
            });
          }
        }
        
        // Overall section fade in/out at edges - faster transitions
        const container = section.querySelector('.project-sticky-container');
        if (container) {
          // Fade in very quickly at start (first 10% of scroll)
          const fadeInProgress = Math.min(1, scrollProgress * 20);
          // Fade out very quickly at end (last 10% of scroll)
          const fadeOutProgress = Math.min(1, (1 - scrollProgress) * 10);
          // Keep at full opacity for most of the scroll
          const opacity = Math.min(fadeInProgress, fadeOutProgress);
          container.style.opacity = Math.max(0.5, opacity);
        }
      }
    });
  }
  
  // Update on scroll with requestAnimationFrame for smooth performance
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateProjectAnimations();
        ticking = false;
      });
      ticking = true;
    }
  });
  
  window.addEventListener('resize', updateProjectAnimations);
  
  // Initial update
  updateProjectAnimations();
</script>
{{ end }}

